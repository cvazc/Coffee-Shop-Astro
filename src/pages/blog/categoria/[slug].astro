---
import { CategoriesSlugSchema, CategorySchema, PostsSchema } from "@/types"
import Layout from "@/layouts/Layout.astro"
import PostCard from "@/components/blog/PostCard.astro"

export async function getStaticPaths() {
	const res = await fetch(
		`${import.meta.env.API_URL}/categories?_fields=slug`
	)
	const json = await res.json()
	const categories = CategoriesSlugSchema.parse(json)
	return categories.map((category) => ({
		params: { slug: category.slug }
	}))
}

const { slug } = Astro.params
const categoryUrl = `${import.meta.env.API_URL}/categories?slug=${slug}`
const categoryRes = await fetch(categoryUrl)
const categoryJson = await categoryRes.json()
const category = CategorySchema.parse(categoryJson[0])

const postsUrl = `${import.meta.env.API_URL}/posts?categories=${category.id}`
const postsRes = await fetch(postsUrl)
const postsJson = await postsRes.json()
const posts = PostsSchema.parse(postsJson)
---

<Layout
	title={`Posts en la categoria: ${category.name}`}
	subtitle={`Posts en la categoria: ${category.name}`}
	bgImage={posts[0].featured_images.full.url}
>
	{posts.map((post) => <PostCard post={post} />)}
</Layout>
